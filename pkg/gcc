# SDK2 package definition for gcc

# Set package-specific variables

PKG_NAME=gcc
SRC_FILE=gcc-8.3.0.tar.gz

SRC_DIR=$PKG_NAME
BUILD_DIR=${PKG_NAME}-build

XD=${SDK2_BUILD_ROOT}/gcc-xcode-sdk

# Functions

unpack () {

    echo "Unpacking $PKG_NAME into $SD"

    # Unpack the tarball

    rm -rf $SD
    mkdir $SD

    tar xf $SF -C $SD --strip-components 1

    if [ $? -ne 0 ]; then
	echo "FAILED in tar for $PKG_NAME (file $SF)"
	exit 1
    fi

    # Create the build dir

    rm -rf $BD
    mkdir $BD

    # On OSX, unpack the XCode SDK

    if [[ $SDK2_PLATFORM_NAME = 'Darwin' ]]; then

	if [[ -z $XCODE_SDK_VERSION ]]; then
	    echo "Profile variable XCODE_SDK_VERSION is not set"
	    exit 1
	fi

	xcode_sdk_file=${SDK2_SRC_ROOT}/MacOSX${XCODE_SDK_VERSION}.sdk.tar.xz

	rm -rf $XD
	mkdir $XD

	tar xf $xcode_sdk_file -C $XD --strip-components 1

	if [ $? -ne 0 ]; then
	    echo "FAILED in tar for $PKG_NAME (file $xcode_sdk_file)"
	    exit 1
	fi

    fi

}

build () {

    echo "Building $PKG_NAME in $BD"

    # Clean up

    cd $BD

    make distclean

    # Remove existing executables & wrappers from DEST_ROOT

    for exec in c++ cpp g++ gcc gfortran; do
	rm -fv ${DEST_ROOT}/bin/$exec ${DEST_ROOT}/bin/$exec.exec
    done

    rm -fv ${DEST_ROOT}/bin/gcc.wrapper
    rm -fv ${DEST_ROOT}/bin/gfortran.wrapper

    # Workaround issues with GCC/LLVM compilers

    if gcc -v 2>&1 | grep -q LLVM; then
	export CC="gcc -D_FORTIFY_SOURCE=0"
    fi

    # Workaround for Ubuntu's multilib madness

    if [[ $SDK2_PLATFORM_NAME = 'Linux' && $SDK2_PLATFORM_DISTRO = 'Ubuntu' ]]; then
	if [[ $SDK2_PLATFORM_ISA = 'i686' ]]; then
            export CPPFLAGS='-I/usr/include/i386-linux-gnu'
            export LIBRARY_PATH='/usr/lib/i386-linux-gnu/'
	elif [[ $SDK2_PLATFORM_ISA = 'x86_64' ]]; then
            export CPPFLAGS='-I/usr/include/x86_64-linux-gnu'
            export LIBRARY_PATH='/usr/lib/x86_64-linux-gnu'
	fi
    fi

    # Set extra configuration options

    EXTRA_CONFIG_OPTS=

    if [[ $SDK2_PLATFORM_NAME = 'Darwin' ]]; then
	EXTRA_CONFIG_OPTS="$EXTRA_CONFIG_OPTS --with-sysroot=${XD}"
    elif [[ $SDK2_PLATFORM_NAME = 'Linux' ]]; then
	EXTRA_CONFIG_OPTS="$EXTRA_CONFIG_OPTS --enable-clocale=generic"
    fi	

    # Configure

    ${SD}/configure CC="$CC_TOOLS" \
        --build=$BUILD_SPEC \
	--prefix=$DEST_ROOT \
	--with-gmp=$DEST_ROOT \
	--with-mpfr=$DEST_ROOT \
	--with-mpc=$DEST_ROOT \
	--enable-languages=c,c++,fortran \
	--disable-multilib \
	--disable-nls \
	--disable-libsanitizer \
	$EXTRA_CONFIG_OPTS

    if [ $? -ne 0 ]; then
	echo "FAILED in configure for $PKG_NAME"
	exit 1
    fi

    # Build

    make -j$NCORES FLAGS_FOR_TARGET="$CPPFLAGS"

    if [ $? -ne 0 ]; then
	echo "FAILED in make for $PKG_NAME"
	exit 1
    fi

}

install () {

    echo "Installing $PKG_NAME from $BD"

    # Install

    cd $BD

    make install

    # Install docs

    cd $SD

    mkdir -pv ${DEST_ROOT}/share/doc/gcc
    cp -av COPYING* INSTALL LAST_UPDATED MAINTAINERS NEWS README ${DEST_ROOT}/share/doc/gcc

    # Install the wrapper scripts

    for exec in c++ cpp g++ gcc; do
	mv -v ${DEST_ROOT}/bin/$exec ${DEST_ROOT}/bin/$exec.exec
	ln -sfv gcc.wrapper ${DEST_ROOT}/bin/$exec
    done

    for exec in gfortran; do
	mv -v ${DEST_ROOT}/bin/$exec ${DEST_ROOT}/bin/$exec.exec
	ln -sfv gfortran.wrapper ${DEST_ROOT}/bin/$exec
    done

    case $SDK2_PLATFORM_NAME in
	Linux)
	    script_dir=${SDK2_PROFILE_ROOT}/common/gcc-linux
	    ;;
	Darwin)
	    script_dir=${SDK2_PROFILE_ROOT}/common/gcc-osx
	    ;;
	*)
	    echo "Unable to determine which wrapper scripts to use"
	    exit 1
    esac

    sed -e s/@SDK_ROOT@/\${${PROFILE_ENV}}/g ${script_dir}/gcc.wrapper > \
	${DEST_ROOT}/bin/gcc.wrapper
    chmod a+x ${DEST_ROOT}/bin/gcc.wrapper

    sed -e s/@SDK_ROOT@/\${${PROFILE_ENV}}/g ${script_dir}/gfortran.wrapper > \
	${DEST_ROOT}/bin/gfortran.wrapper
    chmod a+x ${DEST_ROOT}/bin/gfortran.wrapper

    # On OSX, move stub libraries and replace them by links to the full
    # library. This is necessary because the install names of stub
    # libraries can't be changed using install_name_tool

    if [[ $SDK2_PLATFORM_NAME = 'Darwin' ]]; then
	for lib in ${DEST_ROOT}/lib/*.dylib; do
            if [ -f $lib ]; then
		if `file $lib | grep -q 'Mach-O .* shared library stub'`; then
                    full_lib_name=`otool -D $lib | awk 'NR == 2' | xargs basename`
                    mkdir -pv ${DEST_ROOT}/lib/stubs
                    mv -v $lib ${DEST_ROOT}/lib/stubs/
                    ln -sfv $full_lib_name $lib
		fi
            fi
	done
    fi

}
